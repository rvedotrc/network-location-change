#!/bin/bash

exec >> /tmp/t.log 2>&1
set -x

exec > >(
	exec /usr/local/bin/multilog t /Users/rachel/git/thomas.rudolf.org.uk/network-location-change/log/main
) 2>&1

set -eu
MYDIR="$( dirname "$0" )"
cd "$MYDIR"

printenv > ./last-env

# For realpath
export PATH=/Users/rachel/git/thomas.rudolf.org.uk/misc-scripts/bin:$PATH

svc() {
	sudo /usr/local/bin/svc "$@"
	# Apparently "!requiretty" isn't enough for sudo.
	# "sudo: no tty present and no askpass program specified"
	# Hence: provide a tty using "screen".
	# -d -m   Start  screen  in  "detached" mode. This creates a new session but doesn't attach to it
	# screen -d -m sudo svc "$@"
}

svn_proxy() {
	if [ $1 = on ] ; then
		perl -i -pe 's/^#\s*(?=http-proxy)//' ~/.subversion/servers
	else
		perl -i -pe 's/^(?=http-proxy)/# /' ~/.subversion/servers
	fi
}

firefox_proxy_type() {
	pushd ~/Library/Application\ Support/Firefox/Profiles/5xdcg2fi.default >/dev/null
	local N

	N=$1 perl -i -wpe '
		s/\(("network.proxy.type"), \d+\)/($1, $ENV{N})/;
	' prefs.js

	popd >/dev/null
}

set_tsocks() {
	local LOC=$1

	local CONF=tsocks.conf.null
	if [ -f "tsocks.conf.$LOC" ] ; then
		CONF=tsocks.conf.$LOC
	fi

	local EXISTING="$( readlink tsocks.conf || : )"
	if [ "$EXISTING" != "$CONF" ] ; then
		rm -f tsocks.conf
		ln -s $CONF tsocks.conf
	fi
}

curl_proxy() {
	local PROXY=$1

	if [ "$PROXY" = off ] ; then
		# FIXME should just rewrite...
		rm -f ~/.curlrc
	else
		# FIXME should just rewrite...
		echo "proxy = $PROXY" > ~/.curlrc
	fi
}

ssh_config() {
	env TAG="$1" perl -i -e '
		while (<>) {
			print;
			if (/# BEGIN NETWORK $ENV{TAG}\s*$/) {
				while (<>) {
					print(), last if /# END NETWORK\s*$/;
					s/^(\s*)#\s*/$1/;
					print;
				}
			} elsif (/# BEGIN NETWORK\b/) {
				while (<>) {
					print(), last if /# END NETWORK\s*$/;
					s/^(\s*)(?!#)(\S)/$1# $2/;
					print;
				}
			}
		}
	' $( realpath ~/.ssh/config )
}

maven_reith_cache() {
	./with-rvm ./maven-set-proxy-active ./maven-settings.xml www-cache.reith.bbc.co.uk "$1"
}

LOC="${1:-$( ./get-location )}"

FF_PROXY_TYPE_MANUAL=1
FF_PROXY_TYPE_PAC=2
FF_PROXY_TYPE_AUTO=4

case "$LOC" in
	Home)
		svn_proxy off
		firefox_proxy_type $FF_PROXY_TYPE_AUTO
		curl_proxy off
		ssh_config NOT-REITH
		maven_reith_cache false
		svc -d $HOME/svscan/openvpn-brunel
		;;
	Reith)
		svn_proxy on
		firefox_proxy_type $FF_PROXY_TYPE_PAC
		curl_proxy http://www-cache.reith.bbc.co.uk:80
		ssh_config REITH
		maven_reith_cache true
		svc -tu $HOME/svscan/openvpn-brunel
		;;
	Roaming)
		svn_proxy off
		firefox_proxy_type $FF_PROXY_TYPE_AUTO
		curl_proxy off
		ssh_config NOT-REITH
		maven_reith_cache false
		svc -d $HOME/svscan/openvpn-brunel
		;;
	*)
		echo "$0: unknown location $LOC" >&2
		exit 1
		;;
esac

set_tsocks "$LOC"

if [ -f "bashrc.$LOC" ] ; then
	rm -f bashrc ; ln -s bashrc.$LOC bashrc
else
	rm -f bashrc ; ln -s bashrc.null bashrc
fi

svc -k $HOME/svscan/socks-proxy
svc -k $HOME/svscan/forge-irc

sleep 1
sudo /usr/local/bin/svstat /Users/rachel/svscan/*

exit
